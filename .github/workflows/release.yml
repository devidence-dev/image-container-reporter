name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Run tests
      run: go test ./... -coverprofile=coverage.out

    - name: Generate coverage report
      run: go tool cover -func=coverage.out

    - name: Install govulncheck
      run: go install golang.org/x/vuln/cmd/govulncheck@latest

    - name: Security scan
      run: govulncheck ./...

    - name: Create release directory
      run: mkdir -p release

    - name: Build binaries
      run: |
        # Build matrix for target platforms (ARM64 and AMD64)
        platforms=(
          "linux/arm64"
          "linux/amd64"
        )

        for platform in "${platforms[@]}"; do
          GOOS=${platform%/*}
          GOARCH=${platform#*/}
          BINARY_NAME="icr-${GOOS}-${GOARCH}"

          if [ "$GOOS" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi

          echo "Building for $GOOS/$GOARCH"
          CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH go build \
            -ldflags="-w -s -X main.version=${GITHUB_REF#refs/tags/v}" \
            -o "release/$BINARY_NAME" \
            ./main.go

          # Generate SHA256 checksum
          sha256sum "release/$BINARY_NAME" > "release/${BINARY_NAME}.sha256"
        done

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        body: |
          ## Image Container Reporter (ICR) ${{ github.ref_name }}

          A powerful tool to scan docker-compose files and report available updates for Docker images from various registries.

          ### Downloads
          - **Linux ARM64**: `icr-linux-arm64` + `icr-linux-arm64.sha256`
          - **Linux AMD64**: `icr-linux-amd64` + `icr-linux-amd64.sha256`

          ### Installation

          **For ARM64 (Raspberry Pi, Apple Silicon, ARM servers):**
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/icr-linux-arm64
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/icr-linux-arm64.sha256
          sha256sum -c icr-linux-arm64.sha256
          chmod +x icr-linux-arm64
          sudo mv icr-linux-arm64 /usr/local/bin/icr
          ```

          **For AMD64 (Standard x86-64 servers):**
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/icr-linux-amd64
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/icr-linux-amd64.sha256
          sha256sum -c icr-linux-amd64.sha256
          chmod +x icr-linux-amd64
          sudo mv icr-linux-amd64 /usr/local/bin/icr
          ```

          For more information, see: https://github.com/${{ github.repository }}/blob/main/README.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}